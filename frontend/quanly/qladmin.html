<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Danh s√°ch th·ªß th∆∞</title>
    <link rel="stylesheet" href="/quanly/css/quanly.css">
</head>

<body>

    <div class="headerds">
        <div class="docgiah1">
            <h1>Danh s√°ch th·ªß th∆∞</h1>
        </div>
        <div class="search-form">
            <button class="them-btn" onclick="showAddForm()">Th√™m th·ªß th∆∞</button>
            <input type="text" id="searchInput" placeholder="T√¨m theo t√™n th·ªß th∆∞...">
            <button type="submit" onclick="timTacGia()">T√¨m</button>
            <button type="button" onclick="loadDocGia()">Hi·ªán t·∫•t c·∫£</button>
        </div>
    </div>

    <div id="addForm">
        <h3>Th√™m th·ªß th∆∞</h3>
        <form id="addDocGiaForm">
            <label>T√™n th·ªß th∆∞:</label><br>
            <input type="text" id="TenDocGia" required><br><br>

            <label>Ng√†y sinh:</label><br>
            <input type="date" id="NgaySinh" required><br><br>

            <label>Gi·ªõi t√≠nh:</label><br>
            <select id="GioiTinh">
                <option value="Nam">Nam</option>
                <option value="N·ªØ">N·ªØ</option>
            </select><br><br>

            <label>S·ªë ƒëi·ªán tho·∫°i:</label><br>
            <input type="text" id="SoDienThoai" required><br><br>

            <label>ƒê·ªãa ch·ªâ:</label><br>
            <input type="text" id="DiaChi" required><br><br>

            <label>Email:</label><br>
            <input type="email" id="Email" required><br><br>

            <label>M·∫≠t kh·∫©u:</label><br>
            <input type="password" id="MatKhau" required><br><br>

            <label>Vai tr√≤:</label><br>
            <select id="MaVaiTro">
                <option value="2">Th·ªß th∆∞</option>
            </select><br><br>

            <button type="button" onclick="saveNewDocGia()">L∆∞u</button>
            <button type="button" onclick="closeAddForm()">H·ªßy</button>
        </form>
    </div>
    <script>
        function hienDanhSach() {
            document.querySelector('.main-table-container').style.display = 'block';
            loadDocGia();
        }

        function showAddForm() {
            document.getElementById('addForm').style.display = 'block';
        }

        function closeAddForm() {
            document.getElementById('addForm').style.display = 'none';
        }

        function saveNewDocGia() {
            const tenDocGia = document.getElementById('TenDocGia').value.trim();
            const ngaySinh = document.getElementById('NgaySinh').value;
            const gioiTinh = document.getElementById('GioiTinh').value;
            const soDienThoai = document.getElementById('SoDienThoai').value.trim();
            const diaChi = document.getElementById('DiaChi').value.trim();
            const email = document.getElementById('Email').value.trim();
            const matKhau = document.getElementById('MatKhau').value.trim();
            const maVaiTro = document.getElementById('MaVaiTro').value;

            // Ki·ªÉm tra ng√†y sinh >= 18 tu·ªïi
            const today = new Date();
            const birthDate = new Date(ngaySinh);
            const age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            const dayDiff = today.getDate() - birthDate.getDate();
            const isOver18 = age > 18 || (age === 18 && (monthDiff > 0 || (monthDiff === 0 && dayDiff >= 0)));

            if (!isOver18) {
                alert("th·ªß th∆∞ ph·∫£i ƒë·ªß 18 tu·ªïi tr·ªü l√™n.");
                return;
            }

            // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i t·ª´ 9 ƒë·∫øn 12 ch·ªØ s·ªë
            const phoneRegex = /^\d{9,12}$/;
            if (!phoneRegex.test(soDienThoai)) {
                alert("S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ t·ª´ 9 ƒë·∫øn 12 ch·ªØ s·ªë.");
                return;
            }

            // Ki·ªÉm tra c√°c tr∆∞·ªùng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng
            if (!tenDocGia || !ngaySinh || !gioiTinh || !soDienThoai || !diaChi || !email || !matKhau || !maVaiTro) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ th√¥ng tin.");
                return;
            }

            // T·∫°o ƒë·ªëi t∆∞·ª£ng v√† g·ª≠i API n·∫øu h·ª£p l·ªá
            const newDocGia = {
                TenDocGia: tenDocGia,
                NgaySinh: ngaySinh,
                GioiTinh: gioiTinh,
                SoDienThoai: soDienThoai,
                DiaChi: diaChi,
                Email: email,
                TenTaiKhoan: tenDocGia,
                MatKhau: matKhau,
                MaVaiTro: maVaiTro
            };

            fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newDocGia)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('th·ªß th∆∞ v√† t√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!');
                        closeAddForm();
                        loadDocGia();
                    } else {
                        alert('L·ªói: C√≥ th·ªÉ do mail ƒë√£ s·ª≠ d·ª•ng');
                    }
                })
                .catch(error => {
                    console.error('L·ªói khi th√™m th·ªß th∆∞:', error);
                    alert('L·ªói khi th√™m th·ªß th∆∞!');
                });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
    </script>
    <button onclick="moFormDoiMatKhauAdmin()">ƒê·ªïi M·∫≠t Kh·∫©u Admin</button>
    <div id="formDoiMatKhauAdmin" style="display:none; background-color: #fff; width: 300px; margin: 50px auto; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <h2 style="text-align: center; font-size: 1.5em; margin-bottom: 20px; color: #333;">ƒê·ªïi M·∫≠t Kh·∫©u Admin</h2>
        <form id="formDoiMatKhauAdminForm">
            <input type="email" id="email" placeholder="Email Admin" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;"><br><br>
            <div style="position: relative;">
                <input type="password" id="matKhauCu" placeholder="M·∫≠t kh·∫©u c≈©" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
                <button type="button" onclick="togglePassword('matKhauCu')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer;">üëÅÔ∏è</button>
            </div>
            <br><br>
            <div style="position: relative;">
                <input type="password" id="matKhauMoi" placeholder="M·∫≠t kh·∫©u m·ªõi" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
                <button type="button" onclick="togglePassword('matKhauMoi')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer;">üëÅÔ∏è</button>
            </div>
            <br><br>
            <div style="position: relative;">
                <input type="password" id="xacNhanMatKhauMoi" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi" required style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
                <button type="button" onclick="togglePassword('xacNhanMatKhauMoi')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer;">üëÅÔ∏è</button>
            </div>
            <br><br>
            <button type="submit" style="width: 100%; padding: 10px; background-color: #4CAF50; border: none; color: white; border-radius: 4px; font-size: 1em; cursor: pointer; margin-top: 10px;">L∆∞u thay ƒë·ªïi</button>
            <button type="button" onclick="huyDoiMatKhauAdmin()" style="width: 100%; padding: 10px; background-color: #f44336; border: none; color: white; border-radius: 4px; font-size: 1em; cursor: pointer; margin-top: 10px;">H·ªßy</button>
        </form>
    </div>

    <script>
        function moFormDoiMatKhauAdmin() {
            document.getElementById('formDoiMatKhauAdmin').style.display = 'block';
        }

        function huyDoiMatKhauAdmin() {
            document.getElementById('formDoiMatKhauAdminForm').reset();
            document.getElementById('formDoiMatKhauAdmin').style.display = 'none';
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        // G·ª≠i form b·∫±ng JavaScript
        document.getElementById('formDoiMatKhauAdminForm').addEventListener('submit', function (e) {
            e.preventDefault(); // NgƒÉn form t·ª± submit

            const email = document.getElementById('email').value;
            const matKhauCu = document.getElementById('matKhauCu').value;
            const matKhauMoi = document.getElementById('matKhauMoi').value;
            const xacNhanMatKhauMoi = document.getElementById('xacNhanMatKhauMoi').value;

            fetch('/DoiMK', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, matKhauCu, matKhauMoi, xacNhanMatKhauMoi })
            })
                .then(response => response.text())
                .then(message => {
                    alert(message);
                })
                .catch(error => {
                    console.error('‚ùå L·ªói g·ª≠i y√™u c·∫ßu:', error);
                    alert('ƒê√£ x·∫£y ra l·ªói khi ƒë·ªïi m·∫≠t kh·∫©u!');
                });
        });
    </script>




    </div>
    <!-- B·∫£ng hi·ªÉn th·ªã danh s√°ch th·ªß th∆∞ -->
    <table id="docGiaTable">
        <thead>
            <tr>
                <th>M√£ th·ªß th∆∞</th>
                <th>T√™n th·ªß th∆∞</th>
                <th>Ng√†y sinh</th>
                <th>Gi·ªõi t√≠nh</th>
                <th>SƒêT</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>Email</th>
                <th>M·∫≠t kh·∫©u</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="docGiaBody">
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </tbody>
    </table>

    <!-- Form s·ª≠a th·ªß th∆∞ -->
    <div id="suaDocGiaForm"
        style="display:none;position: fixed; top: 20%; left: 30%; background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 0 10px gray;">
        <h2>S·ª≠a ƒê·ªôc Gi·∫£</h2>
        <form id="formSua">
            <input type="hidden" id="suaMaDocGia">

            <input type="text" id="suaTenDocGia" placeholder="T√™n th·ªß th∆∞"><br>
            <input type="date" id="suaNgaySinh"><br>

            <label>Gi·ªõi t√≠nh:</label>
            <input type="radio" name="suaGioiTinh" value="Nam"> Nam
            <input type="radio" name="suaGioiTinh" value="N·ªØ"> N·ªØ<br>

            <input type="text" id="suaSoDienThoai" placeholder="S·ªë ƒëi·ªán tho·∫°i"><br>
            <input type="text" id="suaDiaChi" placeholder="ƒê·ªãa ch·ªâ"><br>
            <input type="email" id="suaEmail" placeholder="Email"><br>
            <input type="matkhau" id="suaMatKhau" placeholder="M·∫≠t kh·∫©u"><br>


            <button type="submit">L∆∞u thay ƒë·ªïi</button>
            <button type="button" onclick="huySua()">H·ªßy</button> <!-- N√∫t H·ªßy -->

        </form>
    </div>

    <script>
        let docGiaData = [];

        // H√†m chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng ng√†y t·ª´ ISO -> dd/mm/yyyy
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Load danh s√°ch th·ªß th∆∞
        function loadDocGia() {
            fetch('http://localhost:3000/api/admin')
                .then(res => res.json())
                .then(data => {
                    docGiaData = data;
                    const tbody = document.getElementById('docGiaBody');
                    tbody.innerHTML = '';
                    data.forEach((dg, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
            <td>${dg.MaDocGia}</td>
            <td>${dg.TenDocGia}</td>
            <td>${formatDate(dg.NgaySinh)}</td>
            <td>${dg.GioiTinh}</td>
            <td>${dg.SoDienThoai}</td>
            <td>${dg.DiaChi}</td>
            <td>${dg.Email}</td>
            <td>${dg.MatKhau}</td>
            <td>
              <button class="sua-btn" onclick="handleSua(${index})">S·ª≠a</button>
              <button class="xoa-btn" onclick="xoaDocGia(${dg.MaDocGia})">X√≥a</button>
            </td>
          `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('L·ªói khi load th·ªß th∆∞:', error));
        }

        // H√†m x·ª≠ l√Ω n√∫t s·ª≠a th·ªß th∆∞
        function handleSua(index) {
            const dg = docGiaData[index];
            document.getElementById('suaMaDocGia').value = dg.MaDocGia;
            document.getElementById('suaTenDocGia').value = dg.TenDocGia;

            const date = new Date(dg.NgaySinh);
            const localDate = new Date(date.getTime() + Math.abs(date.getTimezoneOffset() * 60000));
            document.getElementById('suaNgaySinh').value = localDate.toISOString().split('T')[0];

            document.querySelector(`input[name="suaGioiTinh"][value="${dg.GioiTinh}"]`).checked = true;
            document.getElementById('suaSoDienThoai').value = dg.SoDienThoai;
            document.getElementById('suaDiaChi').value = dg.DiaChi;
            document.getElementById('suaEmail').value = dg.Email;
            document.getElementById('suaMatKhau').value = dg.MatKhau;

            document.getElementById('suaDocGiaForm').style.display = 'block';
        }


        // H√†m g·ª≠i c·∫≠p nh·∫≠t th√¥ng tin th·ªß th∆∞
        document.getElementById('formSua').addEventListener('submit', function (e) {
            e.preventDefault(); // Ch·∫∑n submit form m·∫∑c ƒë·ªãnh

            const ma = document.getElementById('suaMaDocGia').value;
            const ten = document.getElementById('suaTenDocGia').value;
            const ngaySinh = document.getElementById('suaNgaySinh').value;
            const gioiTinhInput = document.querySelector('input[name="suaGioiTinh"]:checked');
            const soDienThoai = document.getElementById('suaSoDienThoai').value;
            const diaChi = document.getElementById('suaDiaChi').value;
            const email = document.getElementById('suaEmail').value;
            const matkhau = document.getElementById('suaMatKhau').value;

            if (ten === "" || !gioiTinhInput) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n v√† ch·ªçn gi·ªõi t√≠nh!");
                return;
            }

            const gioiTinh = gioiTinhInput.value;

            fetch(`http://localhost:3000/api/admin/${ma}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    TenDocGia: ten,
                    NgaySinh: ngaySinh,
                    GioiTinh: gioiTinh,
                    SoDienThoai: soDienThoai,
                    DiaChi: diaChi,
                    Email: email,
                    MatKhau: matkhau
                })
            })
                .then(res => res.text())   // V√¨ backend tr·∫£ TEXT
                .then(msg => {
                    alert(msg);  // Hi·ªán th√¥ng b√°o t·ª´ server
                    document.getElementById('suaDocGiaForm').style.display = 'none'; // ·∫®n form
                    loadDocGia(); // Reload l·∫°i danh s√°ch
                })
                .catch(error => console.error('L·ªói khi c·∫≠p nh·∫≠t:', error));
        });

        // H√†m x√≥a th·ªß th∆∞
        function xoaDocGia(maDocGia) {
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th·ªß th∆∞ m√£ ${maDocGia}?`)) {
                fetch(`http://localhost:3000/api/admin/${maDocGia}`, {
                    method: 'DELETE'
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert('X√≥a th·ªß th∆∞ th√†nh c√¥ng');
                            loadDocGia();
                        } else {
                            alert('C√≥ l·ªói khi x√≥a');
                        }
                    })
                    .catch(error => {
                        console.error('L·ªói x√≥a:', error);
                        alert('Kh√¥ng th·ªÉ x√≥a');
                    });
            }
        }
        function huySua() {
            document.getElementById("suaDocGiaForm").style.display = "none";
            document.getElementById("formSua").reset(); // (kh√¥ng b·∫Øt bu·ªôc) X√≥a n·ªôi dung ƒë√£ nh·∫≠p trong form n·∫øu b·∫°n mu·ªën
        }

        // Load danh s√°ch th·ªß th∆∞ khi trang t·∫£i xong
        document.addEventListener('DOMContentLoaded', loadDocGia);
    </script>



    <!----------------------T√¨m ki·∫ømki·∫øm---------->
    <script>
        function timTacGia() {
            const tuKhoa = document.getElementById('searchInput').value.toLowerCase();
            const tbody = document.getElementById('docGiaBody');
            tbody.innerHTML = '';

            const ketQua = docGiaData.filter(dg =>
                dg.TenDocGia.toLowerCase().includes(tuKhoa)
            );

            if (ketQua.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="8">Kh√¥ng t√¨m th·∫•y th·ªß th∆∞ n√†o.</td>`;
                tbody.appendChild(row);
                return;
            }

            ketQua.forEach((dg, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
          <td>${dg.MaDocGia}</td>
          <td>${dg.TenDocGia}</td>
          <td>${formatDate(dg.NgaySinh)}</td>
          <td>${dg.GioiTinh}</td>
          <td>${dg.SoDienThoai}</td>
          <td>${dg.DiaChi}</td>
          <td>${dg.Email}</td>
          <td>
            <button class="sua-btn" onclick="handleSua(${docGiaData.indexOf(dg)})">S·ª≠a</button>
            <button class="xoa-btn" onclick="xoaDocGia(${dg.MaDocGia})">X√≥a</button>
          </td>
        `;
                tbody.appendChild(row);
            });
        }
    </script>
    <!----------------------------X√≥a-->
    <script>
        function xoaDocGia(maDocGia) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th·ªß th∆∞ n√†y kh√¥ng?')) {
                fetch(`http://localhost:3000/api/admin/${maDocGia}`, {
                    method: 'DELETE'
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert('X√≥a th·ªß th∆∞ th√†nh c√¥ng!');
                            loadDocGia();
                        } else {
                            alert('Kh√¥ng x√≥a ƒë∆∞·ª£c: ' + data.message);
                        }
                    })
                    .catch(err => {
                        console.error('L·ªói khi x√≥a th·ªß th∆∞:', err);
                        alert('L·ªói khi x√≥a th·ªß th∆∞!');
                    });
            }
        }

    </script>


</body>

</html>