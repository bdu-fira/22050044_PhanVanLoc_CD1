<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω s√°ch</title>
  <link rel="stylesheet" href="\quanly\css\quanly.css">
  <style>
    .add-form-container {
      display: none;
      /* ·∫®n form khi ch∆∞a nh·∫•n n√∫t Th√™m s√°ch */
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div class="headerds">
    <div class="docgiah1">
      <h1>Qu·∫£n l√Ω s√°ch</h1>
    </div>
    <div class="search-form">
      <button class="them-btn" onclick="toggleAddForm()">Th√™m s√°ch</button>
      <select id="searchField">
        <option value="TenSach">T√™n s√°ch</option>
        <option value="TenTacGia">T√°c gi·∫£</option>
        <option value="TenNXB">Nh√† xu·∫•t b·∫£n</option>
        <option value="TheLoai">Th·ªÉ lo·∫°i</option>
      </select>
      <input type="text" id="searchInput" placeholder="Nh·∫≠p t·ª´ kh√≥a...">
      <button onclick="timSach()">T√¨m</button>
      <button onclick="loadSach()">Hi·ªán t·∫•t c·∫£</button>
    </div>
    
  </div>
  </div>

  <!-- Form th√™m s√°ch s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã khi nh·∫•n n√∫t "Th√™m s√°ch" -->
  <div class="add-form-container" id="addFormContainer">
    <form action="/themsach" method="POST">
      <div class="container">
        <div class="convit1">
          <label for="TenSach">T√™n s√°ch: </label>
          <input type="text" id="TenSach" name="TenSach" placeholder="T√™n s√°ch" required><br>

          <label for="TheLoai">Th·ªÉ lo·∫°i: </label>
          <input type="text" id="TheLoai" name="TheLoai" placeholder="Th·ªÉ lo·∫°i" required><br>

          <label for="NhaXuatBan">Nh√† xu·∫•t b·∫£n: </label>
          <select id="NhaXuatBan" name="MaNXB" required>
            <!-- C√°c option s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y th√¥ng qua JavaScript -->
          </select><br>
        </div>

        <div class="convit2">
          <label for="NamXuatBan">Ng√†y xu·∫•t b·∫£n: </label>
          <input type="date" id="NamXuatBan" name="NamXuatBan" required><br>

          <label for="MaTacGia">M√£ t√°c gi·∫£: </label>
          <input type="text" id="MaTacGia" name="MaTacGia" placeholder="M√£ t√°c gi·∫£" required><br>

          <label for="SoLuong">S·ªë l∆∞·ª£ng: </label>
          <input type="number" id="SoLuong" name="SoLuong" placeholder="S·ªë l∆∞·ª£ng" min="0" required><br>

          <label for="anh">Link ·∫£nh: </label>
          <input type="text" id="Anh" name="Anh" placeholder="D√°n link ·∫£nh v√†o ƒë√¢y"><br>          
        </div>
        <button type="button" class="btn-sach" onclick="cancelAddForm()">Hu·ª∑</button>
        <button type="submit" class="btn-sach">Th√™m s√°ch</button>
      </div>
    </form>
  </div>

  <script>
    // H√†m t·∫£i d·ªØ li·ªáu Nh√† Xu·∫•t B·∫£n t·ª´ server v√† th√™m v√†o dropdown
    function loadNhaXuatBan() {
      fetch('http://localhost:3000/api/nhaxuatban')  // Ch·ªânh s·ª≠a ƒë∆∞·ªùng d·∫´n ƒë·ªÉ g·ªçi ƒë√∫ng route
        .then(response => response.json())
        .then(data => {
          const dropdown = document.getElementById('NhaXuatBan');
          data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.MaNXB; // L∆∞u gi√° tr·ªã l√† M√£ nh√† xu·∫•t b·∫£n
            option.textContent = `${item.MaNXB} - ${item.TenNXB}`; // Hi·ªÉn th·ªã c·∫£ M√£ v√† T√™n nh√† xu·∫•t b·∫£n
            dropdown.appendChild(option);
          });
        })
        .catch(err => {
          console.error('Error fetching NhaXuatBan data:', err);
        });
    }

    // G·ªçi h√†m loadNhaXuatBan khi trang ƒë∆∞·ª£c t·∫£i
    window.onload = loadNhaXuatBan;
  </script>

  <!-----------------------b·∫≠t t·∫Øt form------------------>
  <script>
    function showAddForm() {
      var addFormContainer = document.getElementById("addFormContainer");
      if (addFormContainer.style.display === "none" || addFormContainer.style.display === "") {
        addFormContainer.style.display = "block";  // Hi·ªÉn th·ªã form
      } else {
        addFormContainer.style.display = "none";   // ·∫®n form
      }
    }

    function cancelAddForm() {
      var addFormContainer = document.getElementById("addFormContainer");
      addFormContainer.style.display = "none";  // ·∫®n form khi b·∫•m Hu·ª∑
      // Optionally: Reset form fields
      addFormContainer.querySelector("form").reset();
    }
  </script>





  <!-- B·∫£ng danh s√°ch s√°ch -->
  <table id="sachTable">
    <thead>
      <tr>
        <th>M√£ s√°ch</th>
        <th>·∫¢nh s√°ch</th>
        <th>T√™n s√°ch</th>
        <th>T√™n NXB</th>
        <th>T√™n t√°c gi·∫£</th>
        <th>Th·ªÉ lo·∫°i</th>
        <th>NƒÉm xu·∫•t b·∫£n</th>
        <th>S·ªë l∆∞·ª£ng</th>
        <th>Thao t√°c</th>
      </tr>
    </thead>
    <tbody id="sachBody">
      <!-- D·ªØ li·ªáu ƒë∆∞·ª£c th√™m qua JavaScript -->
    </tbody>
  </table>

  <script>
    // Hi·ªÉn th·ªã/·∫©n form th√™m s√°ch
    function toggleAddForm() {
      const form = document.getElementById("addFormContainer");
      form.style.display = (form.style.display === "block") ? "none" : "block";
    }

    function cancelAddForm() {
      const form = document.getElementById("addFormContainer");
      form.style.display = "none";
      form.querySelector("form").reset();
    }


    // T·∫£i d·ªØ li·ªáu nh√† xu·∫•t b·∫£n
    let filteredSachData = []; // L∆∞u danh s√°ch s√°ch ƒë√£ l·ªçc sau t√¨m ki·∫øm

function loadNhaXuatBan() {
  fetch('http://localhost:3000/api/nhaxuatban')
    .then(res => res.json())
    .then(data => {
      const dropdown = document.getElementById('NhaXuatBan');
      dropdown.innerHTML = '';
      data.forEach(nxb => {
        const option = document.createElement('option');
        option.value = nxb.MaNXB;
        option.textContent = `${nxb.MaNXB} - ${nxb.TenNXB}`;
        dropdown.appendChild(option);
      });
    })
    .catch(err => console.error('‚ùå L·ªói t·∫£i NXB:', err));
}

function loadSach() {
  fetch('http://localhost:3000/api/sach')
    .then(res => res.json())
    .then(data => {
      filteredSachData = data; // G√°n to√†n b·ªô s√°ch ban ƒë·∫ßu v√†o bi·∫øn to√†n c·ª•c
      renderSachTable(data);
    })
    .catch(error => console.error('‚ùå L·ªói t·∫£i s√°ch:', error));
}

function renderSachTable(data) {
  const tbody = document.getElementById('sachBody');
  tbody.innerHTML = '';
  data.forEach((sach, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${sach.MaSach}</td>
      <td><img src="${sach.Anh}" alt="·∫¢nh s√°ch" width="100" height="120" /></td>
      <td>${sach.TenSach}</td>
      <td>${sach.TenNXB}</td>
      <td>${sach.TenTacGia}</td>
      <td>${sach.TheLoai}</td>
      <td>${new Date(sach.NamXuatBan).toLocaleDateString()}</td>
      <td>${sach.SoLuong}</td>
      <td>
        <button class="sua-btn" onclick="handleSuaSach(${index})">S·ª≠a</button>
        <button class="xoa-btn" onclick="xoaSach('${sach.MaSach}')">X√≥a</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function handleSuaSach(index) {
  const sach = filteredSachData[index]; // D√πng d·ªØ li·ªáu ƒë√£ l·ªçc

  document.getElementById("EditMaSach").value = sach.MaSach;
  document.getElementById("EditAnh").value = sach.Anh;
  document.getElementById("AnhPreview").src = sach.Anh;

  document.getElementById("EditTenSach").value = sach.TenSach;
  document.getElementById("EditTheLoai").value = sach.TheLoai;
  document.getElementById("EditMaTacGia").value = sach.MaTacGia;
  document.getElementById("EditSoLuong").value = sach.SoLuong;

  const date = new Date(sach.NamXuatBan);
  const localDate = new Date(date.getTime() + Math.abs(date.getTimezoneOffset() * 60000));
  document.getElementById("EditNamXuatBan").value = localDate.toISOString().split('T')[0];

  const dropdown = document.getElementById('EditNhaXuatBan');
  dropdown.innerHTML = '';
  fetch('http://localhost:3000/api/nhaxuatban')
    .then(res => res.json())
    .then(dsNXB => {
      dsNXB.forEach(item => {
        const option = document.createElement('option');
        option.value = item.MaNXB;
        option.textContent = `${item.MaNXB} - ${item.TenNXB}`;
        if (item.MaNXB === sach.MaNXB) option.selected = true;
        dropdown.appendChild(option);
      });
    })
    .catch(err => console.error('‚ùå L·ªói t·∫£i danh s√°ch NXB:', err));

  document.getElementById("editFormContainer").style.display = "block";
}

function submitEditForm() {
  const maSach = document.getElementById("EditMaSach").value;
  const formData = {
    TenSach: document.getElementById("EditTenSach").value,
    TheLoai: document.getElementById("EditTheLoai").value,
    MaNXB: document.getElementById("EditNhaXuatBan").value,
    NamXuatBan: document.getElementById("EditNamXuatBan").value,
    MaTacGia: document.getElementById("EditMaTacGia").value,
    SoLuong: document.getElementById("EditSoLuong").value,
    Anh: document.getElementById("EditAnh").value
  };

  fetch(`http://localhost:3000/api/sach/${maSach}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
  })
    .then(res => res.json())
    .then(data => {
      alert(data.message || "‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!");
      cancelEditForm();
      loadSach();
    })
    .catch(err => console.error("‚ùå L·ªói khi c·∫≠p nh·∫≠t s√°ch:", err));
}

function cancelEditForm() {
  document.getElementById("editFormContainer").style.display = "none";
}

function xoaSach(maSach) {
  if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën xo√° s√°ch m√£ ${maSach}?`)) {
    fetch(`http://localhost:3000/api/sach/${maSach}`, {
      method: 'DELETE'
    })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "üóëÔ∏è Xo√° th√†nh c√¥ng!");
        loadSach();
      })
      .catch(err => console.error("‚ùå L·ªói khi xo√° s√°ch:", err));
  }
}

function normalize(str) {
  return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function timSach() {
  const keyword = normalize(document.getElementById('searchInput').value.trim());
  const field = document.getElementById('searchField').value;

  fetch('http://localhost:3000/api/sach')
    .then(res => res.json())
    .then(data => {
      filteredSachData = data.filter(sach => {
        const fieldValue = normalize(sach[field] || '');
        return fieldValue.includes(keyword);
      });

      renderSachTable(filteredSachData);

      if (filteredSachData.length === 0) {
        document.getElementById('sachBody').innerHTML = `<tr><td colspan="9">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</td></tr>`;
      }
    })
    .catch(err => console.error("‚ùå L·ªói t√¨m ki·∫øm s√°ch:", err));
}

function previewAnh() {
  const link = document.getElementById("EditAnh").value;
  document.getElementById("AnhPreview").src = link;
}

window.onload = () => {
  loadNhaXuatBan();
  loadSach();
};
</script>
<div class="add-form-container" id="editFormContainer" style="display: none;">
  <form action="/suasach" method="POST" enctype="multipart/form-data">
    <div class="container">
      <input type="hidden" id="EditMaSach" name="MaSach">
      <div class="convit1">
        <label for="EditTenSach">T√™n s√°ch:</label>
        <input type="text" id="EditTenSach" name="TenSach" placeholder="T√™n s√°ch" required><br>

        <label for="EditTheLoai">Th·ªÉ lo·∫°i:</label>
        <input type="text" id="EditTheLoai" name="TheLoai" placeholder="Th·ªÉ lo·∫°i" required><br>

        <label for="EditNhaXuatBan">Nh√† xu·∫•t b·∫£n:</label>
        <select id="EditNhaXuatBan" name="MaNXB" required></select><br>
      </div>

      <div class="convit2">
        <label for="EditNamXuatBan">Ng√†y xu·∫•t b·∫£n:</label>
        <input type="date" id="EditNamXuatBan" name="NamXuatBan" required><br>

        <label for="EditMaTacGia">M√£ t√°c gi·∫£:</label>
        <input type="text" id="EditMaTacGia" name="MaTacGia" placeholder="M√£ t√°c gi·∫£" required><br>

        <label for="EditSoLuong">S·ªë l∆∞·ª£ng:</label>
        <input type="number" id="EditSoLuong" name="SoLuong" min="0" required><br>

        <label for="EditAnh">·∫¢nh (URL):</label>
        <input type="text" id="EditAnh" name="EditAnh" oninput="previewAnh()" />
        <img id="AnhPreview" src="" alt="·∫¢nh xem tr∆∞·ªõc" style="width:100px; height:120px; margin-top:10px;" />
      </div>

      <button type="button" class="btn-sach" onclick="cancelEditForm()">Hu·ª∑</button>
      <button type="button" class="btn-sach" onclick="submitEditForm()">L∆∞u thay ƒë·ªïi</button>
    </div>
  </form>
</div>

<script>
  function previewAnh() {
    const link = document.getElementById("EditAnh").value;
    document.getElementById("AnhPreview").src = link;
  }
</script>

<!-- T√¨m ki·∫øm -->



</body>

</html>