<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th∆∞ Vi·ªán</title>
    <link rel="stylesheet" href="css/style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</head>
<body>
 <header>
        <!-- Toggle menu cho mobile -->
        <input type="checkbox" id="menu-toggle" hidden>
        <label class="menu-toggle" for="menu-toggle">
            <i class="fa fa-bars"></i>
        </label>
        <div class="logo">
            <img src="img/Logo-BDU.png" alt="">
        </div>
        <!-- TO√ÄN B·ªò menu + others ƒê∆Ø·ª¢C G·ªòP L·∫†I TRONG .menu -->
        <div class="menu">
            <div class="menu__header"> 
                <h2>Menu</h2> 
            </div>        
            <li><a href="index.html">TRANG CH·ª¶</a></li>
            <li><a href="Noiquy.html">N·ªòI QUY</a></li>
            <li><a href="Xemsach.html">XEM S√ÅCH</a></li>
            <li><a href="ThongTin.html">TH√îNG TIN</a></li>
            <li><a href="Lienhe.html">LI√äN H·ªÜ</a></li>  
            <div class="others">
                <li><input placeholder="T√¨m ki·∫øm"  type="text"> <i class="fas fa-search"></i></li>
                <div class="menu__item"> 
                    <a class="fa-solid fa-file" href="Giohang.html"><span>Gi·ªè h√†ng</span></a>                    
                </div>
                <div class="menu__item"> 
                    <a class="fa fa-user" href="login.html"><span>ƒêƒÉng nh·∫≠p</span></a>
                </div>
            </div>
        </div>
    </header>

    <div class="xemsach-img">
        <img src="img/anh7.jpg" alt="">
    </div>
<!--  -->
<form id="viewInfoForm">
  <h1>Th√¥ng Tin T√†i Kho·∫£n</h1>

  <input type="text" id="tenDocGia" placeholder="T√™n t√†i kho·∫£n">
  <input type="email" id="email" placeholder="Email">
  <input type="date" id="ngaySinh">

  <div class="gender-section">
    <label class="gender-label">Gi·ªõi t√≠nh:</label>
    <div class="gender">
      <input type="radio" name="gender" value="Nam"> Nam
      <input type="radio" name="gender" value="N·ªØ"> N·ªØ
    </div>
  </div>

  <input type="tel" id="soDienThoai" placeholder="S·ªë ƒëi·ªán tho·∫°i">
  <input type="text" id="diaChi" placeholder="ƒê·ªãa ch·ªâ">
  <input type="text" id="tinhTrang" placeholder="T√¨nh tr·∫°ng t√†i kho·∫£n" readonly>

  <!-- N√∫t C·∫≠p nh·∫≠t v√† H·ªßy -->
  <div class="form-actions">
    <button type="button" id="cancelBtn">H·ªßy</button>
    <button type="button" id="updateBtn">C·∫≠p nh·∫≠t</button>
  </div>
</form>


<script>
  // ‚úÖ H√ÄM T·∫¢I D·ªÆ LI·ªÜU NG∆Ø·ªúI D√ôNG L√äN FORM
  function loadUserInfo() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || !user.maDocGia) {
      alert("Ch∆∞a ƒëƒÉng nh·∫≠p!");
      return;
    }

    fetch(`/api/duyetDG/${user.maDocGia}`)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const info = data.user;

          document.getElementById("tenDocGia").value = info.TenDocGia;
          document.getElementById("email").value = info.Email;

          // ‚úÖ S·ª≠a l·ªói ng√†y sinh b·ªã l√πi 1 ng√†y
          if (info.NgaySinh) {
            const date = new Date(info.NgaySinh);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            document.getElementById("ngaySinh").value = `${year}-${month}-${day}`;
}

          document.getElementById("soDienThoai").value = info.SoDienThoai;
          document.getElementById("diaChi").value = info.DiaChi;
          document.getElementById("tinhTrang").value = info.TinhTrang === 1 ? "ƒê√£ duy·ªát" : "Ch·ªù duy·ªát";

          const genderInputs = document.querySelectorAll("input[name='gender']");
          genderInputs.forEach(input => {
            input.checked = input.value === info.GioiTinh;
          });
        } else {
          alert("H√£y ƒëƒÉng k√Ω ƒë·ªÉ c√≥ th·ªÉ m∆∞·ª£n s√°ch.");
        }
      })
      .catch(error => {
        console.error("L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng:", error);
        alert("L·ªói k·∫øt n·ªëi server!");
      });
  }

  // ‚úÖ G·ªåI KHI DOM S·∫¥N S√ÄNG
  document.addEventListener("DOMContentLoaded", loadUserInfo);

  // ‚úÖ X·ª¨ L√ù KHI NH·∫§N N√öT C·∫¨P NH·∫¨T
  document.getElementById("updateBtn").addEventListener("click", () => {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || !user.maDocGia) {
      alert("Ch∆∞a ƒëƒÉng nh·∫≠p!");
      return;
    }

    const ngaySinhStr = document.getElementById("ngaySinh").value;
    const ngaySinh = new Date(ngaySinhStr);
    const today = new Date();

    // ‚úÖ Ki·ªÉm tra tu·ªïi >= 18
    const age = today.getFullYear() - ngaySinh.getFullYear();
    const monthDiff = today.getMonth() - ngaySinh.getMonth();
    const dayDiff = today.getDate() - ngaySinh.getDate();

    const isUnder18 = age < 18 || (age === 18 && (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)));
    if (isUnder18) {
      alert("Ng√†y sinh kh√¥ng h·ª£p l·ªá. B·∫°n ph·∫£i ƒë·ªß 18 tu·ªïi tr·ªü l√™n.");
      return;
    }

    // ‚úÖ Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i
    const soDienThoai = document.getElementById("soDienThoai").value.trim();
    if (!/^\d{10,11}$/.test(soDienThoai)) {
      alert("S·ªë ƒëi·ªán tho·∫°i ph·∫£i t·ª´ 10 ƒë·∫øn 11 ch·ªØ s·ªë v√† ch·ªâ ch·ª©a s·ªë.");
      return;
    }

    // ‚úÖ T·∫°o object d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t
    const data = {
      TenDocGia: document.getElementById("tenDocGia").value,
      Email: document.getElementById("email").value,
      NgaySinh: ngaySinhStr,
      GioiTinh: document.querySelector("input[name='gender']:checked")?.value,
      SoDienThoai: soDienThoai,
      DiaChi: document.getElementById("diaChi").value,
    };

    // ‚úÖ G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t
    fetch(`/api/duyetDG/${user.maDocGia}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
          loadUserInfo(); // üîÅ T·∫£i l·∫°i form
        } else {
          alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i.");
        }
      })
      .catch(error => {
        console.error("L·ªói khi c·∫≠p nh·∫≠t:", error);
        alert("L·ªói k·∫øt n·ªëi server!");
      });
  });
</script>









<div class="cart-container">
    <h1>Gi·ªè h√†ng c·ªßa b·∫°n</h1>

    <table class="cart-table">
        <thead>
            <tr>
                <th>·∫¢nh</th>
                <th>T√™n s√°ch</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>Ch·ªçn</th>
                <th>X√≥a</th>
            </tr>
        </thead>
        <tbody id="cart-body">
            <!-- C√°c d√≤ng s√°ch s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y qua JavaScript -->
        </tbody>
    </table>

    <div class="cart-summary">
        <button class="checkout-btn">Ti·∫øn h√†nh m∆∞·ª£n s√°ch</button>
    </div>
</div>
<!-- Modal x√°c nh·∫≠n m∆∞·ª£n s√°ch -->
<div id="confirm-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:white; padding:20px; border-radius:10px; width:90%; max-width:500px;">
        <h3>X√°c nh·∫≠n m∆∞·ª£n s√°ch</h3>
        <div id="confirm-books-list"></div>
        <div style="margin-top:20px; text-align:right;">
            <button onclick="closeModal()">H·ªßy</button>
            <button id="confirm-borrow" style="background:green; color:white;">X√°c nh·∫≠n m∆∞·ª£n</button>
        </div>
    </div>
</div>

<script>
    const borrowedBooks = JSON.parse(localStorage.getItem('borrowedBooks')) || [];
    const cartBody = document.getElementById('cart-body');

    // H√†m ƒë·∫øm s·ªë checkbox ƒëang ƒë∆∞·ª£c ch·ªçn
    function countSelectedCheckboxes() {
        return document.querySelectorAll('.book-checkbox:checked').length;
    }

    // Duy·ªát t·ª´ng s√°ch ƒë·ªÉ t·∫°o d√≤ng trong b·∫£ng
    borrowedBooks.forEach((sach, index) => {
        const row = document.createElement('tr');

        row.innerHTML = `
            <td><img src="${sach.anh}" alt="${sach.tensach}" class="cart-img"></td>
            <td>${sach.tensach}</td>
            <td><input type="number" value="1" min="1"></td>
            <td><input type="checkbox" class="book-checkbox" data-index="${index}"></td>
            <td><button class="delete-btn" data-masach="${sach.masach}"><i class="fa-solid fa-trash"></i></button></td>
        `;

        cartBody.appendChild(row);
    });

    // S·ª± ki·ªán khi ch·ªçn checkbox
    document.querySelectorAll('.book-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            if (countSelectedCheckboxes() > 3) {
                alert("B·∫°n ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 3 quy·ªÉn ƒë·ªÉ m∆∞·ª£n!");
                this.checked = false;
            }
        });
    });

    // S·ª± ki·ªán x√≥a s√°ch
// S·ª± ki·ªán x√≥a s√°ch
    // S·ª± ki·ªán x√≥a s√°ch
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function () {
            const masach = this.getAttribute('data-masach');
            const updatedBooks = borrowedBooks.filter(sach => sach.masach !== masach);
            localStorage.setItem('borrowedBooks', JSON.stringify(updatedBooks));
            location.reload();
        });
    });

</script>

<script>
    function showModal(books) {
        const modal = document.getElementById('confirm-modal');
        const list = document.getElementById('confirm-books-list');
        list.innerHTML = books.map(book => `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <img src="${book.anh}" alt="${book.tensach}" style="width:50px;">
                <span>${book.tensach}</span>
            </div>
        `).join('');
        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('confirm-modal').style.display = 'none';
    }

    // X·ª≠ l√Ω khi nh·∫•n n√∫t "M∆∞·ª£n"
    document.querySelector('.checkout-btn').addEventListener('click', async () => {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.maDocGia) {
            alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi m∆∞·ª£n s√°ch.");
            return;
        }

        // Ki·ªÉm tra t√¨nh tr·∫°ng t√†i kho·∫£n
        const response = await fetch(`/api/duyetDG/${user.maDocGia}`);
        const data = await response.json();
        if (!data.success || data.user.TinhTrang !== 1) {
            alert("T√†i kho·∫£n c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c duy·ªát. B·∫°n kh√¥ng th·ªÉ m∆∞·ª£n s√°ch.");
            return;
        }

        const checkedBoxes = document.querySelectorAll('.book-checkbox:checked');
        if (checkedBoxes.length === 0) {
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt quy·ªÉn s√°ch ƒë·ªÉ m∆∞·ª£n.");
            return;
        }

        if (checkedBoxes.length > 3) {
            alert("Ch·ªâ ƒë∆∞·ª£c m∆∞·ª£n t·ªëi ƒëa 3 quy·ªÉn s√°ch.");
            return;
        }

        const borrowedBooks = JSON.parse(localStorage.getItem('borrowedBooks')) || [];
        const selectedBooks = [];

        checkedBoxes.forEach(box => {
            const index = parseInt(box.getAttribute('data-index'));
            if (!isNaN(index) && borrowedBooks[index]) {
                selectedBooks.push({
                    masach: borrowedBooks[index].masach,
                    tensach: borrowedBooks[index].tensach,
                    anh: borrowedBooks[index].anh,
                    soluong: 1
                });
            }
        });

        // Hi·ªán modal x√°c nh·∫≠n
        showModal(selectedBooks);

        // Khi nh·∫•n x√°c nh·∫≠n trong modal
        document.getElementById('confirm-borrow').onclick = async () => {
            const payload = {
                maDocGia: user.maDocGia,
                danhSachSach: selectedBooks
            };

            try {
                const response = await fetch('/api/docgia/muon-sach', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`L·ªói m√°y ch·ªß: ${text}`);
                }

                const result = await response.json();
                alert("M∆∞·ª£n s√°ch th√†nh c√¥ng!");

                const remainingBooks = borrowedBooks.filter((_, index) => {
                    return !Array.from(checkedBoxes).some(cb => parseInt(cb.getAttribute('data-index')) === index);
                });

                localStorage.setItem('borrowedBooks', JSON.stringify(remainingBooks));
                closeModal();
                location.reload();
            } catch (error) {
                console.error("L·ªói khi g·ª≠i y√™u c·∫ßu m∆∞·ª£n s√°ch:", error);
                alert("ƒê√£ x·∫£y ra l·ªói khi m∆∞·ª£n s√°ch: " + error.message);
            }
        };
    });
</script>

 

<footer>
    <div class="footer-container">
        <div class="footer-section">
            <h3>Gi·ªõi thi·ªáu</h3>
            <p>Th∆∞ vi·ªán c·ªßa ch√∫ng t√¥i cung c·∫•p nhi·ªÅu ƒë·∫ßu s√°ch phong ph√∫, ƒëa d·∫°ng cho m·ªçi l·ª©a tu·ªïi.</p>
        </div>
        <div class="footer-section">
            <h3>Li√™n h·ªá</h3>
            <p>Email: thuviendemo@gmail.com</p>
            <p>ƒêi·ªán tho·∫°i: 0123-456-789</p>
        </div>
        <div class="footer-section">
            <h3>Theo d√µi ch√∫ng t√¥i</h3>
            <div class="social-icons">
                <a href="#"><i class="fa-brands fa-facebook"></i></a>
                <a href="#"><i class="fa-brands fa-instagram"></i></a>
                <a href="#"><i class="fa-brands fa-twitter"></i></a>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>¬© 2024 Th∆∞ Vi·ªán ƒê·∫°i H·ªçc B√¨nh D∆∞∆°ng</p>
    </div>
</footer>
</div>
</body>
<script src="js/header.js"></script>
<script src="js/banner.js"></script>
</html>